/**
 * Système de Navigation par Onglets pour la Page Événements
 * Gestion des tabs avec effet fade
 */

(function() {
  'use strict';

  // Configuration
  const CONFIG = {
    fadeDuration: 400, // Durée de l'effet fade (ms)
  };

  // Variables d'état
  let currentCard = 0;
  let totalCards = 0;
  let cards = null;
  let tabButtons = null;
  let isDesktop = false;

  /**
   * Initialisation
   */
  function init() {
    // Vérifier si on est sur la page événements
    if (!document.getElementById('eventsCardsContainer')) {
      return;
    }

    // Récupérer les éléments
    cards = document.querySelectorAll('.events-card');
    tabButtons = document.querySelectorAll('.events-tab-btn');

    if (!cards.length || !tabButtons.length) {
      console.error('Events Tabs: Éléments requis non trouvés');
      return;
    }

    // Compter les cartes
    totalCards = cards.length;

    // Vérifier le mode (desktop vs mobile)
    checkDesktopMode();

    // Initialiser les événements
    initEvents();

    // Afficher la première carte
    showCard(0, false);

    console.log('Events Tabs: Initialisé avec succès', {
      totalCards,
      isDesktop
    });
  }

  /**
   * Vérifier si on est en mode desktop
   */
  function checkDesktopMode() {
    isDesktop = window.innerWidth >= 992;
  }

  /**
   * Initialiser les événements
   */
  function initEvents() {
    // Clics sur les boutons d'onglets
    tabButtons.forEach((btn, index) => {
      btn.addEventListener('click', () => {
        if (!isDesktop) {
          showCard(index, true);
        }
      });
    });

    // Clavier (uniquement sur mobile)
    document.addEventListener('keydown', handleKeyboard);

    // Resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        checkDesktopMode();
        updateDisplay();
      }, 150);
    });
  }

  /**
   * Gestion du clavier
   */
  function handleKeyboard(e) {
    if (isDesktop) return;

    switch(e.key) {
      case 'ArrowLeft':
      case '1':
        e.preventDefault();
        showCard(0, true);
        break;
      case 'ArrowRight':
      case '2':
        e.preventDefault();
        showCard(1, true);
        break;
      case 'Tab':
        // Laisser Tab fonctionner normalement
        break;
    }
  }

  /**
   * Afficher une carte spécifique
   */
  function showCard(index, animate = true) {
    // Vérifier l'index
    if (index < 0 || index >= totalCards) return;
    
    // Si on est sur desktop, ne rien faire
    if (isDesktop) return;

    // Si c'est déjà la carte active, ne rien faire
    if (index === currentCard) return;

    // Mettre à jour l'index actuel
    currentCard = index;

    // Mettre à jour les cartes
    updateCards(animate);

    // Mettre à jour les boutons d'onglets
    updateTabButtons();

    // Annoncer le changement pour les lecteurs d'écran
    announceCardChange();
  }

  /**
   * Mettre à jour les cartes
   */
  function updateCards(animate) {
    cards.forEach((card, index) => {
      if (index === currentCard) {
        card.classList.add('active');
      } else {
        card.classList.remove('active');
      }
    });
  }

  /**
   * Mettre à jour les boutons d'onglets
   */
  function updateTabButtons() {
    tabButtons.forEach((btn, index) => {
      if (index === currentCard) {
        btn.classList.add('active');
        btn.setAttribute('aria-current', 'true');
      } else {
        btn.classList.remove('active');
        btn.removeAttribute('aria-current');
      }
    });
  }

  /**
   * Mettre à jour l'affichage selon le mode
   */
  function updateDisplay() {
    if (isDesktop) {
      // Desktop : afficher toutes les cartes
      cards.forEach(card => {
        card.classList.add('active');
      });
    } else {
      // Mobile : afficher seulement la carte active
      showCard(currentCard, false);
    }
  }

  /**
   * Annoncer le changement de carte pour l'accessibilité
   */
  function announceCardChange() {
    const currentCardElement = cards[currentCard];
    
    if (currentCardElement) {
      const tabBtn = tabButtons[currentCard];
      const tabText = tabBtn ? tabBtn.querySelector('.events-tab-text') : null;
      
      if (tabText) {
        const announcement = document.createElement('div');
        announcement.setAttribute('role', 'status');
        announcement.setAttribute('aria-live', 'polite');
        announcement.setAttribute('aria-atomic', 'true');
        announcement.className = 'sr-only';
        announcement.textContent = `Affichage de : ${tabText.textContent}`;
        
        document.body.appendChild(announcement);
        
        setTimeout(() => {
          document.body.removeChild(announcement);
        }, 1000);
      }
    }
  }

  /**
   * Initialiser l'effet parallax (si disponible)
   */
  function initParallax() {
    const section = document.querySelector('.events-section');
    if (!section || !window.jarallax) return;

    try {
      jarallax(section, {
        speed: 0.45,
        imgPosition: '50% 40%'
      });
    } catch (e) {
      console.warn('Events Tabs: Parallax non disponible', e);
    }
  }

  /**
   * Démarrage
   */
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      init();
      // Initialiser le parallax après un court délai
      setTimeout(initParallax, 100);
    });
  } else {
    init();
    setTimeout(initParallax, 100);
  }

  // Export pour debug
  window.EventsTabs = {
    showCard,
    getCurrentCard: () => currentCard,
    getTotalCards: () => totalCards,
    isDesktop: () => isDesktop
  };

})();
