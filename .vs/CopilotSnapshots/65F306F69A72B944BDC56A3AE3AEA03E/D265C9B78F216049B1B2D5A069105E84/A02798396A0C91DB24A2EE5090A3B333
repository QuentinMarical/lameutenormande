<section class="mbr-section mbr-section--no-padding" data-bg-video="{{bg.type == 'video' && bg.value.url}}" mbr-class="{'mbr-fullscreen': fullScreen, 'mbr-parallax-background': bg.parallax}">

    <mbr-parameters>
        <header>Size</header>
        <input type="checkbox" title="Full Screen" name="fullScreen">
        <input type="range" inline title="Top" name="paddingTop" min="0" max="9" step="1" value="7" condition="fullScreen == false">
        <input type="range" inline title="Bottom" name="paddingBottom" min="0" max="9" step="1" value="1" condition="fullScreen == false">

        <header>Background</header>
        <fieldset type="background" name="bg" parallax>
            <input type="image" title="Background Image" value="file:///C:/Users/maric/Desktop/Projet%20Mobirise%20Site%20Meute%20Normande/assets/images/img-2921-2000x1186.jpg" parallax selected>
            <input type="color" title="Background Color" value="#2d2d3d">
            <input type="video" title="Background Video" value>
        </fieldset>
        <input type="checkbox" title="Overlay" name="overlay" condition="bg.type !== 'color'" checked>
        <input type="color" title="Overlay Color" name="overlayColor" value="#1a1a2e" condition="overlay && bg.type !== 'color'">
        <input type="range" inline title="Opacity" name="overlayOpacity" min="0" max="1" step="0.1" value="0.8" condition="overlay && bg.type !== 'color'">

        <header>Calendrier FullCalendar</header>
        <input type="text" title="URL iCalendar" name="icalUrl" value data-ical-url>

        <header>Contrôles</header>
        <input type="checkbox" title="Autoriser Vue Calendrier" name="allowCalendarView" checked>
        <input type="checkbox" title="Autoriser Vue Liste" name="allowListView" checked>
        <input type="checkbox" title="Vue Liste par défaut (Mobile)" name="defaultListViewMobile" condition="allowListView" checked>
    </mbr-parameters>

    <div class="mbr-overlay" mbr-if="overlay && bg.type!== 'color'" mbr-style="{'opacity': overlayOpacity, 'background-color': overlayColor}">
    </div>

    <link rel="stylesheet" href="module-calendrier.css">

    <div class="container container-calendar" mbr-class="{'container': !fullScreen}" data-allow-list-view="{{allowListView}}" data-allow-calendar-view="{{allowCalendarView}}" data-default-list-view-mobile="{{defaultListViewMobile}}">
        <div class="calendar-zone">
            <div class="calendar-loader" id="calendar-loader" style="display: flex; align-items: center; justify-content: center; min-height: 300px;">
                <div style="text-align:center; width:100%;">
                    <div class="loader-spinner" style="margin: 0 auto 1rem auto; width: 48px; height: 48px; border: 6px solid #eee; border-top: 6px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <div id="calendar-loader-message" style="color:#888; font-size:1.1rem;">Chargement du calendrier...</div>
                    <div id="calendar-loader-progress" style="width: 100%; max-width: 320px; height: 8px; background: #eee; border-radius: 5px; margin: 18px auto 0 auto; overflow: hidden; display: none;">
                        <div id="calendar-loader-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>
            <div class="calendar-wrapper" id="calendar-wrapper" style="display:none;">
                <div class="calendar-header">
                    <button class="calendar-arrow-btn calendar-prev">‹</button>
                    <div class="calendar-controls-center">
                        <button class="calendar-btn calendar-today">Aujourd'hui</button>
                        <button class="calendar-btn" id="btn-toggle-view" mbr-if="allowListView && allowCalendarView">Vue Liste</button>
                        <button class="calendar-btn btn-subscribe-style" id="btn-subscribe">📅 S'abonner</button>
                        <span class="calendar-month">Décembre 2024</span>
                    </div>
                    <button class="calendar-arrow-btn calendar-next">›</button>
                </div>
                <div class="fullcalendar-container"></div>
            </div>
        </div>
    </div>

    <div class="event-modal">
        <div class="event-modal-overlay"></div>
        <div class="event-modal-content">
            <button class="event-modal-close">×</button>
            <h3 class="event-modal-title"></h3>
            <div class="event-modal-body"></div>
        </div>
    </div>

    <!-- FullCalendar & ical.js (chargés depuis CDN dans la page d'import) -->
    <link href="https://unpkg.com/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" type="text/css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js" crossorigin="anonymous"></script>

    <script>
    'use strict';

    (function() {
      const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

      const container = document.querySelector('.container-calendar');
      const getAttr = (name) => { if (!container) return true; const val = container.getAttribute(name); return val !== 'false'; };

      const allowListView = getAttr('data-allow-list-view');
      const allowCalendarView = getAttr('data-allow-calendar-view');
      const defaultListViewMobile = getAttr('data-default-list-view-mobile');

      let calendar = null;
      let currentDate = new Date();
      let updateTimeout = null;
      let currentView = (!allowCalendarView && allowListView) ? 'listMonth' : 'dayGridMonth';
      let loadedEvents = [];
      const isMobile = () => window.innerWidth <= 768;
      const isPortrait = () => window.matchMedia('(orientation: portrait)').matches;

      function closeEventModal() {
        const modal = document.querySelector('.event-modal');
        if (modal) {
          modal.classList.add('closing');

          setTimeout(() => {
            modal.classList.remove('show');
            modal.classList.remove('closing');
            modal.setAttribute('aria-hidden', 'true');
            modal.removeAttribute('role');
            document.body.classList.remove('modal-open');
          }, 300);
        }
      }

      function openEventModal(event, props) {
        const modal = document.querySelector('.event-modal');
        const modalTitle = document.querySelector('.event-modal-title');
        const modalBody = document.querySelector('.event-modal-body');

        if (!modal || !modalTitle || !modalBody) return;

        document.body.classList.add('modal-open');

        requestAnimationFrame(() => {
          modal.setAttribute('role', 'dialog');
          modal.setAttribute('aria-modal', 'true');
          modal.setAttribute('aria-hidden', 'false');
          modalTitle.id = 'modal-title';
          modal.setAttribute('aria-labelledby', 'modal-title');

          modalTitle.textContent = props.summary || event.title;

        let leftHTML = '';
        let rightHTML = '';

        if (props.startDate) {
          const isAllDay = !!event.allDay;
          const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
          const timeOptions = { hour: '2-digit', minute: '2-digit' };
          const startDateOnly = props.startDate.toLocaleDateString('fr-FR', dateOptions);
          const startTime = !isAllDay ? props.startDate.toLocaleTimeString('fr-FR', timeOptions) : null;
          const startDisplay = isAllDay ? `${startDateOnly} — Journée entière` : `${startDateOnly} • ${startTime}`;

          leftHTML += `\n            <div class="event-info-row">\n              <div class="event-info-icon">📅</div>\n              <div class="event-info-content">\n                <div class="event-info-label">Début</div>\n                <div class="event-info-text">${startDisplay}</div>\n              </div>\n            </div>`;
        }

        if (props.endDate && props.endDate.toDateString() !== props.startDate.toDateString()) {
          const isAllDay = !!event.allDay;
          let displayEndDate = new Date(props.endDate);
          if (isAllDay) displayEndDate = new Date(props.endDate.getTime() - 24*60*60*1000);
          const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
          const timeOptions = { hour: '2-digit', minute: '2-digit' };
          const endDateOnly = displayEndDate.toLocaleDateString('fr-FR', dateOptions);
          const endTime = !isAllDay ? props.endDate.toLocaleTimeString('fr-FR', timeOptions) : null;
          const endDisplay = isAllDay ? `${endDateOnly} — Journée entière` : `${endDateOnly} • ${endTime}`;
          const durationDays = Math.ceil((displayEndDate - props.startDate) / (24*60*60*1000)) + (isAllDay ? 1 : 0);

          leftHTML += `\n            <div class="event-info-row">\n              <div class="event-info-icon">🏁</div>\n              <div class="event-info-content">\n                <div class="event-info-label">Fin</div>\n                <div class="event-info-text">${endDisplay} (${durationDays} jour${durationDays>1?'s':''})</div>\n              </div>\n            </div>`;
        }

        if (props.location) {
          const encodedLocation = encodeURIComponent(props.location);
          leftHTML += `\n            <div class="event-info-row">\n              <div class="event-info-icon">📍</div>\n              <div class="event-info-content">\n                <div class="event-info-label">Lieu</div>\n                <div class="event-info-text">${props.location}</div>\n                <div class="event-location-buttons">\n                  <a href="https://www.google.com/maps/search/${encodedLocation}" target="_blank" rel="noopener" class="location-btn location-google">Google Maps</a>\n                  <a href="https://www.waze.com/ul?q=${encodedLocation}" target="_blank" rel="noopener" class="location-btn location-waze">Waze</a>\n                  <a href="http://maps.apple.com/?q=${encodedLocation}" target="_blank" rel="noopener" class="location-btn location-apple">Apple Plans</a>\n                </div>\n              </div>\n            </div>`;
        }

        if (props.description) {
          rightHTML += `\n            <div class="event-info-row">\n              <div class="event-info-icon">📝</div>\n              <div class="event-info-content">\n                <div class="event-info-label">Description</div>\n                <div class="event-info-text">${props.description}</div>\n              </div>\n            </div>`;
        }

        if (props.url && props.url.trim()) {
          rightHTML += `\n            <div class="event-info-row">\n              <div class="event-info-icon">🔗</div>\n              <div class="event-info-content">\n                <div class="event-info-label">Lien de l'événement</div>\n                <div class="event-info-text">\n                  <a href="${props.url}" target="_blank" rel="noopener" class="event-url-button">Accéder au site</a>\n                </div>\n              </div>\n            </div>`;
        }

          modalBody.innerHTML = `\n            <div class="event-modal-body-grid">\n              <div class="event-modal-left">${leftHTML}</div>\n              <div class="event-modal-right">${rightHTML}</div>\n            </div>`;
           modal.classList.add('show');

          setTimeout(() => {
            const closeBtn = modal.querySelector('.event-modal-close');
            if (closeBtn) closeBtn.focus();
          }, 100);
        });
      }

      function updateMonthLabel(date) {
        const monthEl = document.querySelector('.calendar-month');
        if (monthEl && date) { monthEl.textContent = monthNames[date.getMonth()] + ' ' + date.getFullYear(); }
      }

      function consolidateMultiDayEvents(events) {
        const map = {};
        events.forEach(ev => {
          const key = ev.id || (ev.title + '_' + (ev.start ? ev.start.toISOString() : Math.random()));
          if (!map[key]) map[key] = { ...ev };
          else {
            if (ev.start && (!map[key].start || ev.start < map[key].start)) map[key].start = ev.start;
            if (ev.end && (!map[key].end || ev.end > map[key].end)) map[key].end = ev.end;
            map[key].extendedProps = { ...(map[key].extendedProps || {}), ...(ev.extendedProps || {}) };
          }
        });

        const now = new Date();
        return Object.values(map).map(ev => {
          const startDate = ev.start || (ev.extendedProps && ev.extendedProps.startDate) || null;
          const endDate = ev.end || (ev.extendedProps && ev.extendedProps.endDate) || null;
          const isPast = endDate && endDate < now;
          const isNow = startDate && endDate && startDate <= now && endDate >= now;
          const isFuture = startDate && startDate > now;
          const classes = [];
          const foxEmojiRegex = /\u{1F98A}/u;
          const hasFox = typeof ev.title === 'string' && foxEmojiRegex.test(ev.title);
          if (isPast) classes.push('fc-event-past');
          else if (isNow) classes.push('fc-event-now');
          else if (isFuture) {
            if (hasFox) {
              classes.push('fc-event-future', 'fc-event-fox');
              ev.extendedProps = ev.extendedProps || {};
              ev.extendedProps.backgroundColor = ev.extendedProps.backgroundColor || 'linear-gradient(135deg, #ff9800, #ff3d00)';
              ev.extendedProps.borderColor = ev.extendedProps.borderColor || '#ff9800';
              ev.extendedProps.textColor = ev.extendedProps.textColor || '#fff';
            } else { classes.push('fc-event-future'); }
          }
          return { ...ev, classNames: classes, id: ev.id };
        });
      }

      function pruneOuterMonthRows() {
        if (!calendar || currentView !== 'dayGridMonth') return;
        const calendarEl = document.querySelector('.fullcalendar-container'); if (!calendarEl) return;
        const view = calendar.view; if (!view || !view.currentStart) return;
        const targetMonth = view.currentStart.getMonth(); const body = calendarEl.querySelector('.fc-daygrid-body'); if (!body) return;
        const rows = body.querySelectorAll('tr'); rows.forEach(row => {
          const cells = row.querySelectorAll('.fc-daygrid-day'); let hasCurrent = false;
          cells.forEach(cell => {
            const dateStr = cell.getAttribute('data-date'); if (dateStr) {
              const d = new Date(dateStr + 'T00:00:00'); if (!isNaN(d) && d.getMonth() === targetMonth) { hasCurrent = true; }
            }
          });
          if (!hasCurrent) row.style.display = 'none'; else row.style.display = '';
        });
        setTimeout(() => { if (calendar) calendar.updateSize(); }, 30);
      }

      function initCalendar(viewName) {
        const calendarEl = document.querySelector('.fullcalendar-container'); const wrapper = document.getElementById('calendar-wrapper');

        if (calendar !== null) calendar.destroy(); resizeWrapperHeight();

        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: viewName,
          initialDate: currentDate,
          locale: 'fr',
          firstDay: 1,
          headerToolbar: false,
          showNonCurrentDates: false,
          height: '100%',
          contentHeight: 'auto',
          expandRows: true,
          dayMaxEvents: false,
          dayMaxEventRows: false,
          eventMaxStack: 99,
          eventDisplay: 'block',
          allDaySlot: true,
          slotMinTime: '06:00:00',
          slotMaxTime: '23:00:00',
          slotLabelInterval: '01:00:00',
          events: loadedEvents,
          eventClick: function(info) { info.jsEvent.preventDefault(); openEventModal(info.event, info.event.extendedProps); },
          eventContent: function(arg) {
             if (arg.view.type.startsWith('list')) {
               const start = arg.event.start; const end = arg.event.end; let html = ''; let nbJours = 1; let isAllDay = arg.event.allDay; const hideStart = arg.event.extendedProps && arg.event.extendedProps.hideStartTime;
               try {
                 const orig = arg.event.extendedProps && arg.event.extendedProps.origStart; if (orig && start) {
                   const sDay = new Date(start.getFullYear(), start.getMonth(), start.getDate()).getTime();
                   const oDay = new Date(orig.getFullYear(), orig.getMonth(), orig.getDate()).getTime(); if (sDay !== oDay) return { html: '' };
                 }
               } catch (e) { }
               if (start && end && end - start >= 24*60*60*1000) {
                 const options = { day: '2-digit', month: 'short', year: 'numeric' };
                 let displayEnd = end; if (isAllDay) displayEnd = new Date(end.getTime() - 24*60*60*1000);
                 const startStr = start.toLocaleDateString('fr-FR', options); const endStr = displayEnd.toLocaleDateString('fr-FR', options);
                 nbJours = Math.round((displayEnd - start) / (24*60*60*1000)) + 1;
                 html += `<div class="fc-event-title">${arg.event.title} <span class="multi-days-span" style="font-weight:normal;font-size:0.95em;margin-left:0.5em;color:#ffc107;">(${nbJours} jour${nbJours>1?'s':''})</span></div>`;
                html += `<div class="fc-list-event-time" style="font-weight:bold;">Du ${startStr} au ${endStr}</div>`;
               } else { html += `<div class="fc-event-title">${arg.event.title}</div>`; }
               return { html };
             }
             return true;
           },
          eventDidMount: function(info) {
            const bg = info.event.extendedProps && info.event.extendedProps.backgroundColor; const border = info.event.extendedProps && info.event.extendedProps.borderColor; const txt = info.event.extendedProps && info.event.extendedProps.textColor;
            if (bg && info.el) { info.el.style.background = bg; if (border) info.el.style.borderColor = border; if (txt) info.el.style.color = txt; }
            try {
              const hideTime = info.event.extendedProps && info.event.extendedProps.hideStartTime; if (hideTime && info.el) {
                const timeEls = info.el.querySelectorAll('.fc-time, .fc-event-time, .fc-list-event-time, .fc-list-event .fc-event-time'); timeEls.forEach(el => el.style.display = 'none');
              }
            } catch (e) { }

            try {
              if (info.view && info.view.type && info.view.type.startsWith('list') && info.el && info.event && info.event.start) {
                const eventStartDate = info.event.start.toISOString().slice(0,10);
                const cellDate = info.el.getAttribute('data-date') || (info.el.closest && info.el.closest('[data-date]') && info.el.closest('[data-date]').getAttribute('data-date')) || (info.el.closest && info.el.closest('tr') && info.el.closest('tr').getAttribute('data-date'));
                if (cellDate && cellDate !== eventStartDate) { info.el.style.display = 'none'; }
              }
            } catch (e) { }

            try { if (info.el && info.el.innerHTML.trim().length === 0) { info.el.style.display = 'none'; } } catch (e) { }
          },
          datesSet: function(info) { if (updateTimeout) clearTimeout(updateTimeout); updateTimeout = setTimeout(() => { const displayDate = info.view.currentStart || info.start; updateMonthLabel(displayDate); pruneOuterMonthRows(); }, 50); }
        });

        calendar.render(); currentView = viewName; updateMonthLabel(currentDate);

        setTimeout(() => { resizeWrapperHeight(); if (calendar) calendar.updateSize(); pruneOuterMonthRows(); }, 100);
      }

      function toggleView() {
        const btnToggleView = document.getElementById('btn-toggle-view'); const calendarZone = document.querySelector('.calendar-zone');

        if (currentView === 'dayGridMonth') { initCalendar('listMonth'); if (btnToggleView) btnToggleView.textContent = 'Vue Calendrier'; if (calendarZone) calendarZone.classList.add('list-view-active'); }
        else { initCalendar('dayGridMonth'); if (btnToggleView) btnToggleView.textContent = 'Vue Liste'; if (calendarZone) calendarZone.classList.remove('list-view-active'); }
      }

      function resizeWrapperHeight() { const wrapper = document.getElementById('calendar-wrapper'); if (!wrapper) return; const top = wrapper.getBoundingClientRect().top; const bottomMargin = 16; const available = window.innerHeight - top - bottomMargin; if (available > 200) { wrapper.style.height = available + 'px'; if (calendar) { setTimeout(() => { calendar.updateSize(); }, 50); } } }

      function handleOrientationChange() {
        if (isMobile()) {
          const calendarZone = document.querySelector('.calendar-zone');
          if (isPortrait()) {
            const shouldBeList = !allowCalendarView || (allowListView && defaultListViewMobile);
            if (shouldBeList && currentView !== 'listMonth') { if (calendarZone) calendarZone.classList.add('list-view-active'); initCalendar('listMonth'); const btnToggleView = document.getElementById('btn-toggle-view'); if (btnToggleView) btnToggleView.textContent = 'Vue Calendrier'; }
          } else {
            const shouldBeCalendar = !allowListView || allowCalendarView;
            if (!allowCalendarView) return;
            if (shouldBeCalendar && currentView !== 'dayGridMonth') { if (calendarZone) calendarZone.classList.remove('list-view-active'); initCalendar('dayGridMonth'); const btnToggleView = document.getElementById('btn-toggle-view'); if (btnToggleView) btnToggleView.textContent = 'Vue Liste'; }
          }
        }
      }

      let scrollBlocked = false;
      function toggleScrollLock(state) { const body = document.body; if (state && !scrollBlocked) { scrollBlocked = true; body.classList.add('scroll-locked'); document.documentElement.classList.add('scroll-locked'); } else if (!state && scrollBlocked) { scrollBlocked = false; body.classList.remove('scroll-locked'); document.documentElement.classList.remove('scroll-locked'); } }

      (function() {
        const calendarEl = document.querySelector('.fullcalendar-container'); const prevBtn = document.querySelector('.calendar-prev'); const nextBtn = document.querySelector('.calendar-next'); const todayBtn = document.querySelector('.calendar-today'); const modalOverlay = document.querySelector('.event-modal-overlay'); const modalClose = document.querySelector('.event-modal-close'); const btnToggleView = document.getElementById('btn-toggle-view');

        if (!calendarEl) return;
        if (typeof FullCalendar === 'undefined' || !FullCalendar.Calendar) {
          const warn = document.createElement('div'); warn.style.cssText = 'padding: 1rem; text-align: center; color: #ffc107; background: rgba(255, 193, 7, 0.1); border-radius: 12px; border: 1px solid #ffc107;'; warn.innerHTML = '⚠️ Le calendrier n\'a pas pu charger les librairies externes (CDN bloqué).<br><small>Essayez d\'autoriser le site ou utilisez une connexion réseau différente.</small>'; calendarEl.appendChild(warn); return; }

        if (modalClose) modalClose.onclick = closeEventModal;
        if (modalOverlay) modalOverlay.onclick = closeEventModal;

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeEventModal(); });

        if (btnToggleView) btnToggleView.onclick = toggleView;

        const btnSubscribe = document.getElementById('btn-subscribe');
        if (btnSubscribe) {
          btnSubscribe.onclick = () => {
            const defaultIcalUrl = "https://calendar.zoho.eu/ical/zz080112301ab3047e81313179c3ee5fd4b00c2a7157b801985735a7b689432472bf947fc87d113e58fdc5e83eea16ec9dc7bc3e4c";
            const icalUrl = document.querySelector('[data-ical-url]')?.getAttribute('data-ical-url') ||
                          document.querySelector('[data-ical-url]')?.getAttribute('value') ||
                          document.querySelector('input[name="icalUrl"]')?.getAttribute('value') ||
                          document.querySelector('input[name="icalUrl"]')?.value ||
                          defaultIcalUrl;

            const subscribeModal = document.createElement('div');
            subscribeModal.className = 'event-modal show';
            subscribeModal.setAttribute('role', 'dialog');
            subscribeModal.setAttribute('aria-modal', 'true');
            subscribeModal.innerHTML = `\n              <div class="event-modal-overlay"></div>\n              <div class="event-modal-content">\n                <button class="event-modal-close">×</button>\n                <h3 class="event-modal-title">📅 S'abonner au calendrier</h3>\n                <div class="event-modal-body">\n                  <div class="event-info-row">\n                    <div class="event-info-icon">🔗</div>\n                    <div class="event-info-content">\n                      <div class="event-info-label">Lien d'abonnement iCal</div>\n                      <div class="event-info-text">\n                        <input type="text" readonly value="${icalUrl}" style="width: 100%; padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: white; font-size: 0.85rem; margin-bottom: 0.5rem;" onclick="this.select()">\n                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">\n                          <button class="event-url-button" onclick="navigator.clipboard.writeText('${icalUrl}'); this.textContent='✓ Copié !'; setTimeout(() => this.textContent='Copier le lien', 2000)" style="flex: 1;">Copier le lien</button>\n                          <button class="event-url-button" onclick="window.open('${icalUrl}', '_blank')" style="flex: 1;">Télécharger</button>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div class="event-info-row">\n                    <div class="event-info-icon">💾</div>\n                    <div class="event-info-content">\n                      <div class="event-info-label">Télécharger et importer</div>\n                      <div class="event-info-text">\n                        <p style="margin: 0 0 0.8rem 0; font-size: 0.9rem;">La méthode la plus simple pour tous les systèmes :</p>\n                        <ol style="margin: 0.5rem 0; padding-left: 1.2rem; font-size: 0.85rem; line-height: 1.6;">\n                          <li><strong>Téléchargez</strong> le fichier iCal avec le lien ci-dessus</li>\n                          <li><strong>Ouvrez</strong> le fichier téléchargé (double-clic ou clic droit → Ouvrir avec)</li>\n                          <li>Sélectionnez votre application de calendrier ou de messagerie<br>(Outlook, Apple Calendar, Google Calendar, Thunderbird, Evolution, etc.)</li>\n                          <li>Confirmez <strong>l'import</strong> du calendrier</li>\n                        </ol>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div class="event-info-row">\n                    <div class="event-info-icon">🌐</div>\n                    <div class="event-info-content">\n                      <div class="event-info-label">S'abonner directement (Web)</div>\n                      <div class="event-info-text">\n                        <p style="margin: 0 0 0.8rem 0; font-size: 0.9rem;">Si votre application supporte les URLs iCal :</p>\n                        <ol style="margin: 0.5rem 0; padding-left: 1.2rem; font-size: 0.85rem; line-height: 1.6;">\n                          <li><strong>Copiez</strong> le lien iCal ci-dessus</li>\n                          <li>Ouvrez <strong>Google Calendar</strong>, <strong>Apple Calendar</strong>, <strong>Outlook</strong>, ou autre</li>\n                          <li>Recherchez l'option <strong>\"Ajouter un calendrier\"</strong> ou <strong>\"S'abonner\"</strong></li>\n                          <li><strong>Collez</strong> le lien iCal fourni</li>\n                        </ol>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div class="event-info-row">\n                    <div class="event-info-icon">ℹ️</div>\n                    <div class="event-info-content">\n                      <div class="event-info-label">Systèmes compatibles</div>\n                      <div class="event-info-text">\n                        <p style="margin: 0; font-size: 0.85rem;">Tous les calendriers et applications de messagerie modernes supportent le format iCal :</p>\n                        <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #ccc;">\n                          📧 <strong>Messagerie :</strong> Outlook, Thunderbird, Evolution, Mail (macOS/iOS)<br>\n                          📅 <strong>Calendrier :</strong> Google Calendar, Apple Calendar, Calendrier (Windows), Gnome Calendar<br>\n                          ☁️ <strong>Autres :</strong> NextCloud, Owncloud, Kolab, et tous les services iCal-compatible\n                        </p>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            `;

            document.body.appendChild(subscribeModal);

            const closeBtn = subscribeModal.querySelector('.event-modal-close');
            const overlay = subscribeModal.querySelector('.event-modal-overlay');

            const closeSubscribe = () => { subscribeModal.remove(); };

            if (closeBtn) closeBtn.onclick = closeSubscribe; if (overlay) overlay.onclick = closeSubscribe;
          };
        }

        window.addEventListener('orientationchange', handleOrientationChange);
        window.addEventListener('resize', handleOrientationChange);
        window.addEventListener('resize', resizeWrapperHeight);
        window.addEventListener('load', resizeWrapperHeight);

        const calendarZone = document.querySelector('.calendar-zone');

        if (calendarZone) {
          const handleScroll = (e) => { if (calendarZone.scrollTop === 0) { toggleScrollLock(false); } else { toggleScrollLock(true); } }
          calendarZone.addEventListener('scroll', handleScroll, { passive: true }); handleScroll();
        }

        window.addEventListener('load', () => { if (calendarZone) toggleScrollLock(calendarZone.scrollTop > 0); });

        (async function() {

          const ICAL_CACHE_DURATION = 6 * 60 * 60 * 1000; // 6 heures
          const getIcalCacheKey = (url) => 'icalcache_' + encodeURIComponent(url);

          const fetchWithRetry = async (url, maxRetries = 1) => {
            for (let i = 0; i < maxRetries; i++) {
              try {
                const response = await fetch(url, { headers: { 'Accept': 'text/calendar, application/ics, text/plain, */*', 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36' }, cache: 'force-cache', mode: 'cors' });
                console.log(`   Réponse: ${response.status} ${response.statusText}, Type: ${response.headers.get('content-type')}`);
                if (response.ok) return response;
                if (response.status === 403 || response.status === 401) throw new Error(`Accès refusé (${response.status}). Vérifiez que le calendrier est public.`);
              } catch (err) { console.log(`   Erreur réseau/parse (${i + 1}/${maxRetries}):`, err.message); if (i === maxRetries - 1) throw err; await new Promise(resolve => setTimeout(resolve, 500 * (i + 1))); }
            }
            throw new Error('Max retries exceeded');
          };

          try {
            const defaultIcalUrl = "./events.ics?v=" + Date.now();

            let icalUrl = document.querySelector('[data-ical-url]')?.getAttribute('data-ical-url') ||
                          document.querySelector('[data-ical-url]')?.getAttribute('value') ||
                          document.querySelector('input[name="icalUrl"]')?.getAttribute('value') ||
                          document.querySelector('input[name="icalUrl"]')?.value ||
                          defaultIcalUrl;

            console.log('URL trouvée:', icalUrl);

            if (!icalUrl || icalUrl.trim().length === 0) { throw new Error('No iCal URL provided in parameters'); }

            let icalText = null; let cacheKey = getIcalCacheKey(icalUrl); let cache = null; try { cache = JSON.parse(localStorage.getItem(cacheKey)); } catch (e) { cache = null; }
            const nowTs = Date.now(); const loaderMsg = document.getElementById('calendar-loader-message'); const loaderBar = document.getElementById('calendar-loader-bar'); const loaderProgress = document.getElementById('calendar-loader-progress'); let usedCache = false;

            if (cache && cache.data && cache.ts && (nowTs - cache.ts < ICAL_CACHE_DURATION)) {
              icalText = cache.data; usedCache = true; if (loaderMsg) loaderMsg.textContent = 'Chargement depuis le cache...'; if (loaderProgress) loaderProgress.style.display = 'none';
              let refreshBtn = document.getElementById('calendar-refresh-btn'); if (!refreshBtn) { refreshBtn = document.createElement('button'); refreshBtn.id = 'calendar-refresh-btn'; refreshBtn.className = 'calendar-btn'; refreshBtn.style.margin = '1rem auto 0 auto'; refreshBtn.textContent = '🔄 Rafraîchir le calendrier'; refreshBtn.onclick = function() { localStorage.removeItem(cacheKey); window.location.reload(); }; const loaderDiv = document.getElementById('calendar-loader'); if (loaderDiv) loaderDiv.appendChild(refreshBtn); }
              console.log('✅ Utilisation du cache localStorage pour le flux iCal');
            } else {
              if (loaderMsg) loaderMsg.innerHTML = 'Téléchargement et mise en cache du calendrier en cours...<br><span style="font-size:0.95em; color:#aaa;">(cela peut prendre 5 à 10 secondes selon la connexion)</span>';
              if (loaderProgress) loaderProgress.style.display = '';
              if (loaderBar) loaderBar.style.width = '0%';
              let response = null;
              const proxies = [ { name: 'Direct', url: icalUrl }, { name: 'allorigins.win', url: 'https://api.allorigins.win/raw?url=' + encodeURIComponent(icalUrl) }, { name: 'corsproxy.io', url: 'https://corsproxy.io/?' + encodeURIComponent(icalUrl) }, { name: 'thingproxy.freehostingz.com', url: 'https://thingproxy.freehostingz.com/fetch/' + encodeURIComponent(icalUrl) } ];
              let lastError = null; let fakeProgress = 0; let fakeInterval = null;
              if (loaderBar) { loaderBar.style.width = '0%'; fakeInterval = setInterval(() => { fakeProgress = Math.min(95, fakeProgress + Math.random() * 5); loaderBar.style.width = fakeProgress + '%'; }, 200); }
              for (let i = 0; i < Math.min(3, proxies.length); i++) {
                const proxy = proxies[i];
                try { console.log(`🔄 Tentative ${i + 1}/${Math.min(3, proxies.length)}: ${proxy.name}`); console.log(`   URL: ${proxy.url.substring(0, 80)}...`); response = await fetchWithRetry(proxy.url, 1); if (response.status === 200) { console.log(`✅ Succès avec ${proxy.name}`); break; } else { console.warn(`⚠️ ${proxy.name} retourné le statut ${response.status}`); } } catch (err) { lastError = err; console.warn(`❌ ${proxy.name} échoué:`, err.message); }
              }
              if (fakeInterval) clearInterval(fakeInterval);
              if (!response || !response.ok) { if (loaderBar) loaderBar.style.width = '0%'; console.error('Dernier erreur:', lastError); throw new Error(`Impossible de charger le calendrier. Dernier essai: ${lastError?.message || 'Unknown'}`); }
              if (!response || !response.ok) { if (loaderBar) loaderBar.style.width = '0%'; throw new Error(`HTTP ${response?.status || 'Network Error'}: ${response?.statusText || 'Failed to load calendar'}`); }
              if (response && response.body && window.ReadableStream) {
                const reader = response.body.getReader(); const contentLength = +response.headers.get('Content-Length') || 0; let receivedLength = 0; let chunks = [];
                while(true) { const {done, value} = await reader.read(); if (done) break; chunks.push(value); receivedLength += value.length; if (loaderBar && contentLength) { const percent = Math.min(100, Math.round(receivedLength / contentLength * 100)); loaderBar.style.width = percent + '%'; } else if (loaderBar) { loaderBar.style.width = ((receivedLength/10000)%100) + '%'; } }
                let chunksAll = new Uint8Array(receivedLength); let pos = 0; for (let chunk of chunks) { chunksAll.set(chunk, pos); pos += chunk.length; }
                icalText = new TextDecoder('utf-8').decode(chunksAll); if (loaderBar) loaderBar.style.width = '100%';
              } else { icalText = await response.text(); if (loaderBar) loaderBar.style.width = '100%'; }
              if (!icalText || icalText.trim().length === 0) { if (loaderBar) loaderBar.style.width = '0%'; throw new Error('iCal file is empty or invalid'); }
              try { localStorage.setItem(cacheKey, JSON.stringify({ data: icalText, ts: nowTs })); console.log('🗄️ Cache localStorage mis à jour pour le flux iCal'); } catch (e) { }
            }

            let jcalData = null; try { jcalData = ICAL.parse(icalText); } catch (parseErr) { throw new Error('Invalid iCal format: ' + parseErr.message); }

            const comp = new ICAL.Component(jcalData); const vevents = comp.getAllSubcomponents("vevent"); loadedEvents = [];
            const eventMap = new Map(); const overrideMap = new Map();
            vevents.forEach((v, i) => { try { const maybeOverride = v.getFirstProperty('recurrence-id'); if (maybeOverride) { const ev = new ICAL.Event(v); const k = (ev.uid || `event-override-${i}`) + '_' + (ev.startDate ? ev.startDate.toJSDate().toISOString() : i); overrideMap.set(k, true); } } catch (err) { } });

            vevents.forEach((vevent, index) => {

              try {
                const event = new ICAL.Event(vevent);
                if (!event.startDate) return;

                function getEventColors(title, start, now) {
                  if (title.includes('🦊') && start > now) { return { backgroundColor: '#ff9800', borderColor: '#ff9800' }; }
                  return { backgroundColor: '#667eea', borderColor: '#667eea' };
                }

                if (event.isRecurring()) {
                  const now = new Date();
                  const rangeStart = new Date(now.getFullYear() - 1, 0, 1);
                  const rangeEnd = new Date(now.getFullYear() + 2, 11, 31, 23, 59, 59);
                  const expand = event.iterator(rangeStart); let next; let count = 0;
                  while ((next = expand.next()) && count < 500) {
                    const occStart = next.toJSDate(); if (occStart > rangeEnd) break; if (occStart < rangeStart) { count++; continue; }
                    let occEnd = null; if (event.endDate) { const duration = event.endDate.subtractDate(event.startDate); occEnd = next.clone(); occEnd.addDuration(duration); occEnd = occEnd.toJSDate(); } else { occEnd = new Date(occStart); }
                    const dtStartProp = vevent.getFirstProperty("dtstart"); const isAllDay = dtStartProp && dtStartProp.getParameter("value") === "DATE";
                    if (isAllDay && occEnd.getTime() !== occStart.getTime()) { occEnd.setDate(occEnd.getDate() + 1); }
                    let cleanTitle = event.summary || "Sans titre";
                    const hasZeroHourInTitle = /(?:\b00h\b|\b00:00\b)/i.test(event.summary || '');
                    cleanTitle = cleanTitle.replace(/\s*\d{1,2}h\s*/gi, "");
                    cleanTitle = cleanTitle.replace(/\s*\d{1,2}:\d{2}.*$/i, ""); cleanTitle = cleanTitle.trim();
                    let eventUrl = ""; if (event.component && event.component.getFirstPropertyValue) { const urlProp = event.component.getFirstPropertyValue("url"); const attachProp = event.component.getFirstPropertyValue("attach"); eventUrl = urlProp || attachProp || ""; }
                    const key = (event.uid || `event-${index}`) + '_' + occStart.toISOString(); if (overrideMap.has(key)) { count++; continue; }
                    if (!eventMap.has(key)) { const colors = getEventColors(cleanTitle, occStart, now);
                      loadedEvents.push({ id: key, title: cleanTitle, start: occStart, end: occEnd, allDay: !!isAllDay, display: "block", backgroundColor: colors.backgroundColor, borderColor: colors.borderColor, extendedProps: { description: event.description || "", location: event.location || "", summary: cleanTitle, hideStartTime: hasZeroHourInTitle, origStart: event.startDate ? event.startDate.toJSDate() : occStart, startDate: occStart, endDate: occEnd, url: eventUrl } }); eventMap.set(key, true); }
                    count++;
                  }
                } else {
                  let startDate = event.startDate.toJSDate(); let endDate = event.endDate ? event.endDate.toJSDate() : new Date(startDate); const dtStartProp = vevent.getFirstProperty("dtstart"); const isAllDay = dtStartProp && dtStartProp.getParameter("value") === "DATE";
                  if (isAllDay && endDate.getTime() !== startDate.getTime()) { endDate.setDate(endDate.getDate() + 1); }
                  let cleanTitle = event.summary || "Sans titre"; const hasZeroHourInTitle = /(?:\b00h\b|\b00:00\b)/i.test(event.summary || ''); cleanTitle = cleanTitle.replace(/\s*\d{1,2}h\s*/gi, ""); cleanTitle = cleanTitle.replace(/\s*\d{1,2}:\d{2}.*$/i, ""); cleanTitle = cleanTitle.trim();
                  let eventUrl = ""; if (event.component && event.component.getFirstPropertyValue) { const urlProp = event.component.getFirstPropertyValue("url"); const attachProp = event.component.getFirstPropertyValue("attach"); eventUrl = urlProp || attachProp || ""; }
                  const key = (event.uid || `event-${index}`) + '_' + startDate.toISOString(); if (!eventMap.has(key)) { const now = new Date(); const colors = getEventColors(cleanTitle, startDate, now); loadedEvents.push({ id: key, title: cleanTitle, start: startDate, end: endDate, allDay: !!isAllDay, display: "block", backgroundColor: colors.backgroundColor, borderColor: colors.borderColor, extendedProps: { description: event.description || "", location: event.location || "", summary: cleanTitle, hideStartTime: hasZeroHourInTitle, origStart: event.startDate ? event.startDate.toJSDate() : startDate, startDate: startDate, endDate: endDate, url: eventUrl } }); eventMap.set(key, true); }
                }
              } catch (e) { console.error('Erreur lors du traitement de l\'événement:', e); }
            });


            loadedEvents = consolidateMultiDayEvents(loadedEvents);

            let startView = 'dayGridMonth';
            if (!allowCalendarView && allowListView) { startView = 'listMonth'; }
            else if (isMobile() && isPortrait() && allowListView && defaultListViewMobile) { startView = 'listMonth'; }
            else if (!allowListView) { startView = 'dayGridMonth'; }


            document.getElementById('calendar-loader').style.display = 'none'; document.getElementById('calendar-wrapper').style.display = '';

            initCalendar(startView);

            const calendarZone = document.querySelector('.calendar-zone');
            const btnToggleView = document.getElementById('btn-toggle-view');

            if (startView === 'listMonth') { if (btnToggleView) btnToggleView.textContent = "Vue Calendrier"; if (calendarZone) calendarZone.classList.add('list-view-active'); }
            else { if (btnToggleView) btnToggleView.textContent = "Vue Liste"; if (calendarZone) calendarZone.classList.remove('list-view-active'); }

            setTimeout(() => { if (loadedEvents.length === 0) { const calendarEl = document.querySelector('.fullcalendar-container'); if (calendarEl) { calendarEl.innerHTML = `<div style="padding:2rem;text-align:center;color:#fff;background:rgba(102,126,234,0.1);border-radius:12px;max-width:600px;margin:0 auto;">Aucun événement à afficher pour cette période.</div>`; } } }, 500);

            if (prevBtn) { prevBtn.onclick = () => calendar && calendar.prev(); prevBtn.setAttribute('aria-label', 'Mois précédent'); }
            if (nextBtn) { nextBtn.onclick = () => calendar && calendar.next(); nextBtn.setAttribute('aria-label', 'Mois suivant'); }
            if (todayBtn) { todayBtn.onclick = () => { if (calendar) { calendar.today(); updateMonthLabel(new Date()); } }; todayBtn.setAttribute('aria-label', 'Aller à aujourd\'hui'); }
          } catch (error) {
            console.error("Erreur de chargement du calendrier:", error);
            const calendarEl = document.querySelector(".fullcalendar-container");
            if (calendarEl) {
              let errorMsg = error.message; let suggestions = '';
              if (error.message.includes('No iCal URL')) { errorMsg = 'Aucune URL iCal n\'a été fournie.'; suggestions = '<br><strong>Action requise :</strong> Entrez une URL iCal valide dans les paramètres du formulaire ci-dessus.'; }
              else if (error.message.includes('Impossible de charger')) { errorMsg = 'Impossible de charger le calendrier avec l\'URL fournie.'; suggestions = '<br><strong>Solutions :</strong><ul style="text-align: left; margin: 1rem 0; padding-left: 1.5rem;"><li>✅ Vérifiez que l\'URL du calendrier Zoho est <strong>correcte</strong> et <strong>publique</strong></li><li>✅ Testez l\'URL directement dans votre navigateur</li><li>✅ Assurez-vous que le partage du calendrier Zoho est activé</li><li>✅ Attendez quelques secondes avant de recharger (cache proxy)</li><li>ℹ️ Consultez la console (F12) pour plus de détails techniques</li></ul>'; }
              else if (error.message.includes('Accès refusé')) { errorMsg = 'Accès refusé au calendrier Zoho.'; suggestions = '<br><strong>Action :</strong> Vérifiez que le calendrier est <strong>public</strong> dans les paramètres de partage Zoho.'; }
              else if (error.message.includes('Invalid iCal')) { errorMsg = 'Le fichier iCal n\'est pas au bon format.'; suggestions = '<br><strong>Conseil :</strong> Vérifiez que l\'URL pointe vers un fichier iCal valide (.ics).'; }
              else if (error.message.includes('empty')) { errorMsg = 'Le fichier iCal est vide.'; }
              else if (error.message.includes('Network') || error.message.includes('réseau')) { errorMsg = 'Erreur de connexion réseau.'; suggestions = '<br><strong>Action :</strong> Vérifiez votre connexion Internet et rechargez la page.'; }

              calendarEl.innerHTML = `
                <div style="padding: 2rem; text-align: center; color: #ffc107; background: rgba(255, 193, 7, 0.1); border-radius: 12px; border: 1px solid #ffc107; max-width: 600px; margin: 0 auto;">
                  ❌ ${errorMsg}<br>
                  <small style="color: #888; margin-top: 0.5rem; display: block;">Ouvrez F12 (console) pour plus de détails techniques</small>
                  ${suggestions}
                </div>`;
            }
          }
        })();
      })();
    </script>

</section>